<!DOCTYPE html>
<html>
<head>
	<title>4Ride Dispatcher</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	<link rel="stylesheet" href="leaflet-routing-machine-2.6.2/css/leaflet-routing-machine.css" />

	<script src="jquery.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<script src="leaflet-routing-machine-2.6.2/dist/leaflet-routing-machine.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
	<script src="http://www.mapquestapi.com/sdk/leaflet/v2.s/mq-map.js?key=Tj4VSXek5VsluA3NxlKokpN79PvlK2EQ"></script>
	<script src="http://www.mapquestapi.com/sdk/leaflet/v2.s/mq-geocoding.js?key=Tj4VSXek5VsluA3NxlKokpN79PvlK2EQ"></script>
</head>
<body>
	<h1>4-RIDE Dispatch Module</h1>
	<div id="map" style="width: 3; height: 600px"></div>

	<script>

		var vanIcon = L.icon({
		    iconUrl: 'leaflet/images/van_icon.png',
		    iconSize: [50, 25] // size of the icon
		});

		var map = L.map('map', {
			layers: MQ.mapLayer()
		}).setView(new L.LatLng(38.899570, -77.047802), 15);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicmZpdHptb3JyaXMiLCJhIjoiY2lrMWxuaWRrMzk5dnZ0bHo0azRnZ204MyJ9.uwX0V-kXg3G6dXcs4r3v5Q', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		}).addTo(map);

		L.Map.include({
  			'clearLayers': function () {
    			this.eachLayer(function (layer) {
      				this.removeLayer(layer);
    			}, this);
  			}
		});

		setTimeout("loadVehicleData()", 10000);


		function loadVehicleData() {

			map.clearLayers();

			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicmZpdHptb3JyaXMiLCJhIjoiY2lrMWxuaWRrMzk5dnZ0bHo0azRnZ204MyJ9.uwX0V-kXg3G6dXcs4r3v5Q', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="http://mapbox.com">Mapbox</a>',
				id: 'mapbox.streets'
			}).addTo(map);

			var postParams = {name: 'deviceType', value: 'DispatchViewer'};
			//$.getJSON( "http://localhost:8080/4RideServlet/Servlet", function( data ) {
				
			$.post("http://localhost:8080/4RideServlet/Servlet", postParams, function(data, textStatus) {
			  var items = [];
			  var itCount = 0;
			  var layers = [];
			  var color = 0;
			  geocoder = new google.maps.Geocoder();

			  $.each( data, function( key1, val ) {

			  	//if(key1 == 2) {

			  	 $.each( val["itinerary"], function( key2, val ) {

			  		var address = val;
			  		//if(itCount % 2 == 0) {

						MQ.geocode().search(address).on('success', function(e) {

							var best = e.result.best

						    var currentAddress = data[key1]["itinerary"][key2];
						    console.log("current address: " + currentAddress);
						    var nextAddress = data[key1]["itinerary"][(key2+1)%data[0]["itinerary"].length];
						    console.log("next address: " + nextAddress);

						    var currentCoords = best.latlng;

						    MQ.geocode().search(nextAddress).on('success', function(e) {

								var best = e.result.best
								var nextCoords = best.latlng;

								/*
						    		var tempMarker = L.marker(best.latlng);
						    		tempMarker.bindPopup("<b>" + data[key1]["driverName"] + "</b><br />Stop #:" + (key2+1)).openPopup();
						    		tempMarker.addTo(map);
								*/

						    	L.Routing.control({
		  							waypoints: [
		    							currentCoords,
		    							nextCoords
		  							],
		  							lineOptions: {
							            styles: [
							            {color: getColor(key1%4), opacity: 1, weight: 3}
							            ]
	           						},
	           						show: false
								}).addTo(map);

				    		});	

							/*
					    		var tempMarker = L.marker(best.latlng);
					    		tempMarker.bindPopup("<b>" + data[key1]["driverName"] + "</b><br />Stop #:" + (key2+1)).openPopup();
					    		tempMarker.addTo(map);
					    	*/

				    	});	
					//}
					//itCount++;

					var vehicleMarker = L.marker(new L.LatLng(data[key1]["location"][0], data[key1]["location"][1]), {icon: vanIcon});
					vehicleMarker.bindPopup("<b>" + data[key1]["driverName"] + "</b>").openPopup();
					vehicleMarker.addTo(map);		

			  	 });
				//}

			  });
			}, "json");
		}

		function codeAddress(address) 
		{
		  geocoder.geocode( {address:address}, function(results, status) 
		  {
		    if (status == google.maps.GeocoderStatus.OK) 
		    {
		      console.log(results[0].geometry.location.lat())
		    } else {
		      alert('Geocode was not successful for the following reason: ' + status);
		   }
		  });
		}

		function makeArray(d1, d2) {
		    var arr = [];
		    for(i = 0; i < d2; i++) {
		        arr.push(new Array(d1));
		    }
		    return arr;
		}

		function getColor(i) {
			switch(i) {
			    case 0:
			        return 'green';
			        break;
			    case 1:
			        return 'red';
			        break;
			    case 2:
			        return 'blue';
			        break;
			    case 3:
			        return 'yellow'
			        break;
			    default:
			        return 'black'
			}
		}

		L.circle([51.508, -0.11], 500, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.5
		}).addTo(map).bindPopup("I am a circle.");

		L.polygon([
			[51.509, -0.08],
			[51.503, -0.06],
			[51.51, -0.047]
		]).addTo(map).bindPopup("I am a polygon.");

/*
		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent("You clicked the map at " + e.latlng.toString())
				.openOn(map);
		}

		map.on('click', onMapClick);
*/

	</script>
</body>
</html>